<!DOCTYPE html>
<html>
<head>
    <title>Test Authentification Supabase</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .container { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 20px; 
            margin-top: 20px;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover { background: #0056b3; }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #auth-status, #user-info {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
        }
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Test d'Authentification Supabase</h1>
    
    <div class="container">
        <h2>1. État de la connexion</h2>
        <div id="auth-status">Non connecté</div>
        
        <div id="login-form">
            <h2>2. Connexion</h2>
            <div>
                <label for="email">Email :</label>
                <input type="email" id="email" placeholder="votre@email.com" value="franchini.cedric@gmail.com">
            </div>
            <div>
                <label for="password">Mot de passe :</label>
                <input type="password" id="password" placeholder="Votre mot de passe">
            </div>
            <button id="login-btn">Se connecter</button>
            <button id="reset-password-btn">Réinitialiser le mot de passe</button>
        </div>
        
        <div id="user-info" style="display: none;">
            <h2>Informations utilisateur</h2>
            <pre id="user-data"></pre>
            <button id="logout-btn">Se déconnecter</button>
        </div>
        
        <h2>Journaux</h2>
        <div id="logs"></div>
    </div>

    <!-- Inclure le SDK Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://svvupcjjqyyehxbxlkro.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2dnVwY2pqcXl5ZWh4Ynhsa3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0Njg3NjcsImV4cCI6MjA2NTA0NDc2N30.wSK-HT0_UCNIVsfrcHQ1OBOlgdbKR4uMICDtbwg6ivY';
        
        // Initialiser Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Éléments du DOM
        const authStatus = document.getElementById('auth-status');
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userData = document.getElementById('user-data');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const logs = document.getElementById('logs');
        
        // Fonction pour ajouter des logs
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #6c757d;">[${timestamp}]</span> ${message}`;
            if (type === 'error') logEntry.style.color = '#dc3545';
            if (type === 'success') logEntry.style.color = '#28a745';
            logs.prepend(logEntry);
        }
        
        // Vérifier l'état d'authentification au chargement
        async function checkAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                addLog('Erreur de session: ' + error.message, 'error');
                return;
            }
            
            if (session) {
                updateUIForUser(session.user);
            } else {
                updateUIForGuest();
            }
        }
        
        // Mettre à jour l'interface pour un utilisateur connecté
        function updateUIForUser(user) {
            authStatus.innerHTML = '<span class="success">✓ Connecté en tant que: ' + user.email + '</span>';
            loginForm.style.display = 'none';
            userInfo.style.display = 'block';
            userData.textContent = JSON.stringify(user, null, 2);
            addLog('Utilisateur connecté: ' + user.email, 'success');
        }
        
        // Mettre à jour l'interface pour un invité
        function updateUIForGuest() {
            authStatus.innerHTML = '<span class="error">Non connecté</span>';
            loginForm.style.display = 'block';
            userInfo.style.display = 'none';
            addLog('Déconnecté', 'info');
        }
        
        // Se connecter avec email/mot de passe
        async function login(email, password) {
            addLog('Tentative de connexion pour: ' + email);
            
            // Afficher un indicateur de chargement
            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.textContent;
            loginBtn.disabled = true;
            loginBtn.textContent = 'Connexion en cours...';
            
            try {
                addLog('Appel de signInWithPassword...');
                
                // Vérifier que supabase est bien défini
                if (!window.supabase) {
                    throw new Error('Supabase n\'est pas chargé correctement');
                }
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                addLog('Réponse de signInWithPassword reçue');
                
                if (error) {
                    addLog('Erreur de Supabase: ' + JSON.stringify(error), 'error');
                    throw error;
                }
                
                if (!data || !data.user) {
                    throw new Error('Aucune donnée utilisateur reçue');
                }
                
                addLog('Utilisateur connecté avec succès: ' + data.user.email);
                updateUIForUser(data.user);
                
            } catch (error) {
                const errorMessage = error.message || 'Erreur inconnue';
                console.error('Erreur détaillée:', error);
                addLog('Erreur de connexion: ' + errorMessage, 'error');
                alert('Erreur de connexion: ' + errorMessage);
            } finally {
                // Réactiver le bouton dans tous les cas
                loginBtn.disabled = false;
                loginBtn.textContent = originalText;
            }
        }
        
        // Se déconnecter
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                addLog('Erreur de déconnexion: ' + error.message, 'error');
            } else {
                updateUIForGuest();
            }
        }
        
        // Réinitialiser le mot de passe
        async function resetPassword(email) {
            if (!email) {
                alert('Veuillez entrer votre adresse email');
                return;
            }
            
            addLog('Envoi du lien de réinitialisation à: ' + email);
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.href // Rediriger vers cette page après réinitialisation
                });
                
                if (error) throw error;
                
                addLog('Lien de réinitialisation envoyé à ' + email, 'success');
                alert('Un lien de réinitialisation a été envoyé à votre adresse email.');
                
            } catch (error) {
                addLog('Erreur lors de l\'envoi du lien: ' + error.message, 'error');
                alert('Erreur: ' + error.message);
            }
        }
        
        // Écouteurs d'événements
        loginBtn.addEventListener('click', () => {
            login(emailInput.value, passwordInput.value);
        });
        
        logoutBtn.addEventListener('click', logout);
        
        resetPasswordBtn.addEventListener('click', () => {
            resetPassword(emailInput.value);
        });
        
        // Permettre la soumission du formulaire avec Entrée
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login(emailInput.value, passwordInput.value);
            }
        });
        
        // Vérifier l'état d'authentification au chargement
        checkAuth();
        
        // Écouter les changements d'état d'authentification
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                updateUIForUser(session.user);
            } else if (event === 'SIGNED_OUT') {
                updateUIForGuest();
            }
        });
    </script>
</body>
</html>
